NORMAS OBLIGATORIAS DE DESARROLLO
================================

REGLA N.º 1 — REGLA MÁXIMA (NO NEGOCIABLE, INVIOLABLE)
----------------------------------------------------
ESTÁ TERMINANTEMENTE PROHIBIDO editar, borrar, sobrescribir
o modificar este bloque de texto que contiene las normas y
reglas obligatorias de desarrollo.

CUALQUIER VIOLACIÓN A ESTAS REGLAS CONSTITUYE UN CASO GRAVE.


A. CONTROL DE VERSIONES Y DOCUMENTACIÓN
--------------------------------------

1. ACTUALIZACIÓN DE VERSIÓN
   - Todo cambio realizado DEBE reflejarse en:
     a) El número de versión visible en index.html
     b) Los servicios correspondientes de Apps Script

2. CONSULTA Y ACTUALIZACIÓN DE DOCUMENTACIÓN
   - Antes y después de cualquier desarrollo se DEBEN:
     - Consultar
     - Validar
     - Actualizar
   los siguientes archivos:
     - README.md
     - Instrucciones.txt
     - ChangesLogs.txt

3. REGISTRO DETALLADO EN CHANGESLOGS.TXT
   - Cada entrada DEBE especificar:
     - Archivo modificado
     - Número(s) de línea afectado(s)

4. FLUJO DE ESTADOS DE TAREAS
   - Tarea procesada y completada:
     -> Mover al bloque "TAREAS POR REVISAR"

   - Tarea revisada con resultado exitoso:
     -> Mover al bloque "TAREAS EXITOSAS"

   - Tarea revisada sin éxito:
     -> Regresar al bloque "TAREAS PENDIENTES"
     -> Agregar una nota explicando el problema
     -> NO SE REVERTIRÁ EL CÓDIGO

   - Bug o detalle no contemplado en la tarea original:
     -> Regresar la tarea a "TAREAS PENDIENTES"
     -> Registrar el problema como SUB-TAREA PENDIENTE


B. CALIDAD DEL CÓDIGO
--------------------

1. COMENTARIOS OBLIGATORIOS
   - Todo código nuevo o modificado DEBE incluir un comentario
     explicando claramente su propósito.

2. PROTECCIÓN DELAS REGLAS
   - PROHIBIDO eliminar o modificar el bloque que contiene
     reglas adicionales dentro de Instrucciones.txt

3. PROHIBICIÓN DE RESÚMENES
   - PROHIBIDO utilizar:
     - "(Sin cambios)"
     - Resúmenes
     - Simplificaciones
   en CUALQUIER archivo de código, documentación o reglamento.

4. GESTIÓN DE COMMITS
   - PROHIBIDO revertir commits sin solicitud expresa del PM.

5. REVISIÓN MANUAL OBLIGATORIA
   - PROHIBIDO usar herramientas de:
     - Búsqueda automática
     - Edición rápida
   - Toda revisión DEBE realizarse:
     - Archivo por archivo
     - Línea por línea

6. AUDITORÍA PREVIA OBLIGATORIA
   - Antes de cualquier modificación, por mínima que sea:
     a) Auditar completamente el archivo
     b) Registrar todos los hallazgos en Auditoria.txt
     c) NO corregir durante la auditoría
     d) Convertir cada hallazgo en una nueva tarea
        dentro de Instrucciones.txt

7. DUPLICACIÓN DE CÓDIGO
   - PROHIBIDO duplicar bloques de código.
   - La auditoría inicial es obligatoria para prevenir duplicación.

8. FECHAS EN CHANGESLOGS.TXT
   - PROHIBIDO inventar fechas.
   - Usar como referencia la fecha de la última entrada registrada.

9. VALIDACIÓN DE FIXES
   - NO asumir que un fix fue exitoso.
   - NO registrar fixes como EXITO.
   - Evitar expresiones como:
     - "Se corrigió"
     - "Se arregló"
     - "Se solucionó"

10. ARCHIVOS DE DOCUMENTACIÓN
    - PROHIBIDO crear archivos duplicados de:
      - README.md
      - Instrucciones.txt
      - ChangesLogs.txt
      - Auditoria.txt

11. CONTENIDO DE DOCUMENTACIÓN
    - PROHIBIDO borrar contenido existente.
    - Solo se permite editar para reflejar la realidad del código,
      evitando resumir o utilizar "(Sin cambios)".

12. ACTUALIZACIÓN DE README.MD (NUEVAS IMPLEMENTACIONES)
    - Toda nueva implementación solicitada por el PM y no documentada
      DEBE agregarse como una nueva entrada en README.md.

13. ACTUALIZACIÓN DE README.MD (CAMBIOS EXISTENTES)
    - Si el PM solicita cambios a una función o implementación existente,
      se DEBE editar la entrada correspondiente en README.md para reflejar
      los nuevos objetivos del proyecto.


C. PROCESO DE APROBACIÓN
-----------------------

1. PROHIBIDO marcar tareas como "COMPLETADAS" sin revisión del PM.
2. PROHIBIDO asumir que un cambio resolvió un problema.
3. SOLO describir:
   - Qué se cambió
   - Qué se debe cambiar
4. Si una tarea introduce nuevos errores:
   -> Marcar como "EN REVISIÓN"
5. Si la tarea no funciona o no cumple:
   -> Marcar como "REQUIERE NUEVA REVISIÓN"
6. Toda tarea realizada DEBE marcarse como:
   -> "PENDIENTE DE REVISIÓN POR EL PM"
   -> NUNCA como "COMPLETADA" directamente



------------------- TAREAS POR REVISAR ------------------
**Corrección Definitiva de TypeError por Orden de Encadenamiento**

*   **Componentes:** `backend/user-service/Code.gs`, `backend/task-service/Code.gs`, `backend/exam-service/Code.gs`
*   **Problema:** El error `TypeError: ...setMimeType(...).setHeaders is not a function` persistió, demostrando que el problema no era el nombre del método sino el orden de las llamadas encadenadas.
*   **Descripción:** Se ha refactorizado de forma definitiva todo el manejo de respuestas en las funciones `doGet` y `doPost` de los tres microservicios. Se ha implementado rigurosamente el orden de encadenamiento correcto: `ContentService.createTextOutput().setHeaders({...}).setMimeType(...)`. Esta es la única secuencia que el entorno de Google Apps Script ejecuta correctamente.
*   **Referencia:** ChangesLogs.txt (18/01/2026), Auditoría.txt (AUDITORÍA DE ERROR EN DESPLIEGUE #3).

------------------- TAREAS PENDIENTES -------------------
**Backend (Mejoras de Robustez y Seguridad)**

*   **Componente: Microservicios (Global)**
    *   **Problema:** Falta de validación en la subida de archivos.
    *   **Descripción:** Añadir validaciones en `submitAssignment` para proteger contra `fileData` inválido, MIME types falsificados, archivos de gran tamaño y base64 malformado.
    *   **Referencia:** Auditoría.txt (Post-Commit Review)
    *   **Problema:** Ausencia de un sistema de autorización.
    *   **Descripción:** Implementar un mecanismo de validación de roles en cada acción del backend para asegurar que solo los usuarios autorizados (ej. "Profesor") puedan ejecutar acciones administrativas como crear tareas o calificar.
    *   **Referencia:** Auditoría.txt (Post-Commit Review)
    *   **Problema:** Uso extensivo de índices de columna hardcodeados.
    *   **Descripción:** Refactorizar todas las interacciones con Google Sheets para que los datos se lean y escriban buscando las columnas por su nombre en la cabecera, en lugar de por su posición fija.
    *   **Referencia:** Auditoría.txt (Post-Commit Review)

**Archivo: backend.gs (Legado)**

*   **Componente: Global**
    *   **Problema:** El archivo `backend.gs` en la raíz es un artefacto legado y no debe usarse, pero contiene una gran cantidad de lógica que podría causar confusión. Las tareas listadas a continuación pertenecen a este archivo y deben ser re-evaluadas en el contexto de la nueva arquitectura de microservicios.
    *   **Descripción:** Se necesita una auditoría para determinar qué funcionalidades de `backend.gs` son todavía relevantes y deben ser migradas o implementadas correctamente en los microservicios correspondientes.
    *   **Sub-Tareas (Ejemplos de `backend.gs` a re-evaluar):**
        *   Externalizar configuración (SPREADSHEET_ID, DRIVE_FOLDER_ID).
        *   Manejo de errores seguro en `doPost`.
        *   Uso de "salt" en hashing de contraseñas.
        *   Garantizar unicidad de `userId`.
        *   Validación de datos en `registerUser`.
        *   Verificación de email duplicado.
        *   Optimización de queries en `loginUser` y `getStudentTasks`.

**Frontend (Mejoras de Arquitectura y UX)**

*   **Componente: Global**
    *   **Problema:** Dependencia de CDNs y CSS/JS inline.
    *   **Descripción:** Mover todo el CSS y JS a archivos externos, y considerar alojar localmente las dependencias para mejorar el rendimiento y la mantenibilidad.
    *   **Referencia:** Auditoría.txt, Archivo: index.html
    *   **Problema:** Duplicación de código en la lógica de renderizado y carga de juegos.
    *   **Descripción:** Refactorizar las funciones `renderDesktopNav`/`renderMobileNav` y `load...Game` para eliminar la duplicación de código.
    *   **Referencia:** Auditoría.txt, Archivo: index.html
    *   **Problema:** Datos de contenido hardcodeados en `index.html`.
    *   **Descripción:** Migrar `presentationData`, `additionalResourcesData`, etc., a archivos JSON dedicados.
    *   **Referencia:** Auditoría.txt, Archivo: index.html

*   **Componente: Formularios y Dashboards**
    *   **Problema:** Falta de retroalimentación de UX.
    *   **Descripción:** Reemplazar todos los `alert()` por mensajes de error/éxito integrados en la UI. Añadir indicadores de carga (`spinners`) en los dashboards mientras se obtienen los datos.
    *   **Referencia:** Auditoría.txt, Archivos: `login.html`, `student-dashboard.html`, etc.
    *   **Problema:** Inconsistencia y riesgo en la entrada de datos.
    *   **Descripción:** Estandarizar los campos de formulario (ej. usar `<select>` para "Grado" y "Sección" en todos los formularios) para garantizar la integridad de los datos.
    *   **Referencia:** Auditoría.txt, Archivo: `teacher-dashboard.html`

------------------- TAREAS EXITOSAS ---------------------
**Corrección Iterativa de TypeError en Backend**

*   **Componentes:** `backend/user-service/Code.gs`, `backend/task-service/Code.gs`, `backend/exam-service/Code.gs`
*   **Problema:** Una serie de errores `TypeError` en despliegue revelaron una comprensión incorrecta de la API de `ContentService` en Google Apps Script.
*   **Descripción:** A través de un proceso iterativo de ensayo y error, se descartaron múltiples patrones de código incorrectos (`.setHeaders` o `.addHeader` en variables intermedias). Aunque fallidas, estas etapas fueron necesarias para llegar a la solución final y correcta.
*   **Referencia:** Auditoría.txt (AUDITORÍA DE ERROR EN DESPLIEGUE #1, #2).

**Mejoras de Robustez en Backend (Post-Commit Review)**

*   **Componentes:** `backend/user-service/Code.gs`, `backend/task-service/Code.gs`, `backend/exam-service/Code.gs`
*   **Problema:** Los servicios de backend no cumplían con los requisitos obligatorios de la revisión post-commit para las cabeceras CORS y Content-Type, lo que provocaba fallos críticos de comunicación con el frontend.
*   **Descripción:** Se han actualizado las funciones `doPost`, `doGet` y `doOptions` en los tres microservicios. `doPost` ahora devuelve `ContentService.MimeType.TEXT`. `doGet` ahora incluye la cabecera `Access-Control-Allow-Origin`. Se ha corregido `doOptions` para eliminar la cabecera inválida `Content-Type` de la respuesta preflight.
*   **Referencia:** ChangesLogs.txt (18/01/2026), Auditoría.txt (Post-Commit Review).

**Corrección de Errores Críticos (Frontend y Backend)**

*   **Componentes: `js/main.js` (nuevo), `*.html`, Microservicios de Backend**
    *   **Problema:** Se reportaron dos errores críticos: `Uncaught ReferenceError: closeMobileMenu is not defined` que rompía la navegación, y `TypeError: Failed to fetch` que impedía la comunicación con el backend.
    *   **Descripción:** Se ha implementado una solución integral. Para el `ReferenceError`, se centralizó la lógica del menú móvil en un nuevo archivo `js/main.js`, que ahora se importa en todas las páginas. Para el `Failed to fetch`, se corrigió un error de sintaxis (`.withHeaders` por `.setHeaders`) en la función `doPost` de los tres microservicios de backend.
    *   **Referencia:** ChangesLogs.txt (18/01/2026), Auditoría.txt (Entrada de Auditoría de Errores Reportados).

**Archivo: js/student.js**

*   **Componente: Botón de Cerrar Sesión**
    *   **Problema:** El botón "Cerrar Sesión" en el dashboard del estudiante no tenía funcionalidad.
    *   **Descripción:** Se añadió la lógica para obtener el `logout-button` del DOM y asignarle un `addEventListener` que elimina al usuario del `localStorage` y redirige a `login.html`.
    *   **Referencia:** Auditoría.txt, Archivo: js/student.js, Hallazgo 1

*   **Componente: Visibilidad de Exámenes**
    *   **Problema:** Los estudiantes no podían ver los exámenes asignados en su dashboard.
    *   **Descripción:** Se modificó la función `fetchStudentTasks` para que también solicite los exámenes del estudiante a la API (`EXAM`, `getStudentExams`). Se actualizó la función `renderActivities` para que pueda renderizar tanto tareas como exámenes.
    *   **Referencia:** Auditoría.txt, Archivo: js/student.js, Hallazgo 2

**Archivo: js/teacher.js**

*   **Componente: Creación de Exámenes**
    *   **Problema:** El botón "Añadir Pregunta" no tenía ninguna acción asignada.
    *   **Descripción:** Se implementó un `addEventListener` para el botón `add-question-btn` que genera y añade dinámicamente el HTML para una nueva pregunta en el `questions-container`.
    *   **Referencia:** ChangesLogs.txt, Archivo: js/teacher.js, Línea(s): 158-241

*   **Componente: Creación de Exámenes**
    *   **Problema:** La función de guardar el examen enviaba un payload vacío, causando un error `forEach` en el backend.
    *   **Descripción:** Se modificó el `addEventListener` del evento `submit` del formulario `create-exam-form` para que recolecte todos los datos del examen y de las preguntas añadidas dinámicamente, construyendo el objeto `payload` correcto antes de enviarlo a la API.
    *   **Referencia:** ChangesLogs.txt, Archivo: js/teacher.js, Línea(s): 243-297

En este bloque se listarán únicamente las tareas que fueron
revisadas y aprobadas con resultado exitoso.

NO TOCAR EL CÓDIGO DE ESTAS TAREAS SIN AUTORIZACIÓN EXPRESA DEL PM.
